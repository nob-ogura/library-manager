# 家族の図書館利用管理システム

## 1. システム概要
1. 単一家族の図書館利用状況をリアルタイムに取得し、柔軟に可視化する
2. 必要に応じて貸出中の書籍の返却日を延長できる

## 2. 要求定義
1. ログインには GitHub アカウントを利用する
   1. 特定の GitHub アカウント以外であればログイン画面に戻す
   2. ログイン成功したアカウントは全画面にアクセス・操作可能
2. 「ダッシュボード」と「詳細」の2画面がある
   1. ダッシュボード画面
      1. 最新状況取得ボタン
         1. 押下すると一覧の冊数情報が「取得中」になる
         2. 取得が完了すると冊数が表示される
      2. 最新状況一覧
         1. 図書館利用者ID
         2. 図書館名
         3. 貸出中の書籍の冊数
         4. 返却日が今日または過去日（＝返却予定）の冊数
         5. 現在取置中の書籍の冊数
         6. `貸出中` - `返却予定` + `取置中` の数が「図書館の貸出上限冊数」を超過した場合は強調表示
   2. 詳細画面
      1. 貸出一覧
         1. 図書館名
         2. 図書館利用者ID
         3. 書籍名
         4. 返却日
            1. 返却日が今日または過去日ならば強調表示
         5. 延長可否
            1. 「延長可」ならば延長ボタン
      2. 予約一覧
         1. 図書館名
         2. 図書館利用者ID
         3. 書籍名
         4. 予約日
         5. 予約状況
            1. 取置中 or 予約待ち(N位)
            2. 取置中ならば強調表示
      - 各一覧はソート可能とする
      - 各一覧の各カラムはフィルタリング可能とする

## 3. データ型定義
1. ログイン可能アカウントリスト
   ```
   {
      "ログイン可能アカウント": ["www@xxx.com", "yyy@zzz.com"]
   }
   ```
2. 図書館情報
   ```
   {
      "図書館ID": 1,
      "図書館名": "xx市立oo図書館",
      "貸出上限冊数": 10,
      "図書館ホームページURL": "https://www.xxoo.jp",
   }
   ```
3. 家族情報
   ```
   {
      "家族ID": "A",
      "名": "xx夫",
      "図書館アカウントリスト": [
      {
         "図書館ID": 1,
         "図書館利用者ID": "XXXXXXXX",
      },
      {
         "図書館ID": 2,
         "図書館利用者ID": "YYYYYYYY",
      }
      ]
   }
   ```
4. 貸出情報
   ```
   {
      "図書館ID": 1,
      "家族ID": "A",
      "書籍名": "oooooooo",
      "返却日": "yyyy-MM-dd",
      "延長可否": true # false: 不可, true: 可
   }
   ```
5. 予約情報
   ```
   {
      "図書館ID": 1,
      "家族ID": "A",
      "書籍名": "oooooooo",
      "予約日": "yyyy-MM-dd",
      "予約状況": 1 # 0: 取置中, 1-999: 予約待ち順位
   }
   ```
- いずれもDB（Supabase）で管理する
- 貸出情報, 予約情報は最新の状況のみ保存する

## 4. 内部処理
1. 図書館情報, 家族情報取得
   1. Supabase より取得
   2. 設定画面なし、テーブルを直接編集
2. 貸出情報, 予約情報取得
   1. 以下の手順で情報をスクレイピングする
      1. 各図書館ホームページより各図書館利用者IDでログイン
         - PW は Google Secret Manager から取得
      2. 貸出画面に遷移
      3. 貸出情報を取得
      4. 予約画面に遷移
      5. 予約情報を取得
      6. ログアウト
3. ダッシュボード表示時の処理
   1. ログイン画面からの遷移であれば自動で最新状況を取得
4. 延長ボタン押下時の処理
   1. 各図書館ホームページより各図書館利用者IDでログイン
      - PW は Google Secret Manager から取得
   2. 貸出画面に遷移
   3. 貸出情報を取得
      - 該当書籍の延長ボタン押下
   4. 延長後の貸出情報を取得
   5. ログアウト

## 5. 技術スタック
1. ランタイム: Bun
2. 言語: TypeScript
3. フレームワーク: HonoX
4. ブラウザ操作: Playwright
5. 認証, DB: Supabase
6. デプロイ先: Google Cloud Run

## 6. 設計手法
1. 貸出情報, 予約情報の取得をストラテジーパターン＋シンプルファクトリーで実装する
2. 「xxをクリックして画面を遷移する」のような共通処理は共用関数とする
3. 動作確認用のモック環境を構築する

## 7. ディレクトリ構成（仮）
<details>
<summary></summary>

```
.
├── app/
│   ├── components/            # サーバーサイドレンダリング用 UIコンポーネント
│   │   ├── Header.tsx         # ナビゲーションバー
│   │   ├── BookCard.tsx       # ダッシュボードの数値表示カード
│   │   └── Layout.tsx         # 全体レイアウト（<html>タグ等）
│   │
│   ├── islands/               # クライアントサイド動作（Hydration）が必要なコンポーネント
│   │   ├── RefreshButton.tsx  # 「取得中」状態を持つ更新ボタン
│   │   ├── BookTable.tsx      # ソート・フィルタリング機能付きテーブル
│   │   └── ExtendButton.tsx   # 非同期で延長処理を行うボタン
│   │
│   ├── routes/                # HonoX ファイルベースルーティング
│   │   ├── _middleware.ts     # 認証チェック、共通処理
│   │   ├── _renderer.tsx      # 全体のHTMLレンダリング定義
│   │   ├── index.tsx          # ログイン画面 (/)
│   │   ├── auth/
│   │   │   └── callback.tsx   # GitHub OAuth コールバック処理
│   │   ├── dashboard/
│   │   │   └── index.tsx      # ダッシュボード画面
│   │   ├── details/
│   │   │   └── index.tsx      # 詳細画面（貸出・予約一覧）
│   │   └── api/               # フロントエンドからの非同期リクエスト用
│   │       ├── status.ts      # 最新状況取得 (POST)
│   │       └── extend.ts      # 延長処理 (POST)
│   │
│   ├── services/              # ビジネスロジック層
│   │   ├── auth.ts            # 認証ロジック (Session管理, GitHub API)
│   │   ├── config.ts          # Supabaseからの設定取得 (図書館情報, 家族情報)
│   │   ├── secrets.ts         # Google Secret Manager 連携
│   │   └── scraper/           # スクレイピング関連 (★設計の肝)
│   │       ├── index.ts       # エントリーポイント
│   │       ├── factory.ts     # Simple Factory (図書館IDからストラテジー生成)
│   │       ├── browser.ts     # Playwright共通処理 (ブラウザ起動、クリック等)
│   │       ├── interfaces.ts  # Strategy Interface定義
│   │       └── strategies/    # 各図書館の実装
│   │           ├── BaseStrategy.ts # 共通の抽象クラス
│   │           ├── MockLibrary.ts  # ★モック環境用
│   │           ├── CityALibrary.ts
│   │           └── CityBLibrary.ts
│   │
│   ├── types/                 # 型定義 (DB定義, レスポンス型)
│   │   └── index.ts
│   │
│   ├── style.css              # グローバルスタイル (Tailwind利用なら不要または設定ファイルへ)
│   └── client.ts              # HonoX エントリーポイント
│
├── .env                       # ローカル環境変数
├── bun.lockb
├── package.json
├── tsconfig.json
├── vite.config.ts             # HonoX ビルド設定
└── Dockerfile                 # Cloud Run デプロイ用設定
```
</details>

## 8. Cloud Run を無料枠で運用する際の留意事項

- 最小インスタンス数は「0」（`min-instances=0`）：`1`にすると無アクセスでも起動し続け課金。0ならリクエスト時だけ起動して課金時間を最小化（ただしコールドスタートで十数秒の遅延あり）。
- 「CPUを常に割り当てる」はOFF：「リクエスト処理中のみCPU割り当て（デフォルト）」を選ぶと、処理完了・レスポンス返却で課金が止まる。
- タイムアウトを適切に設定：処理時間が長いほど課金秒数が増えるため、プログラム側で適切に設定し、無限ループ等を防ぐ。
- Egress（外向き通信）は課金対象：Ingressは無料だが、画像配信やDB保存などのEgressは課金。東京リージョン（asia-northeast1）は北米の1GB無料枠が適用されない可能性があるため、大量画像返却などを避ける。
